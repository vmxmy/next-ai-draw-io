generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js（OAuth）默认表结构
// 参考：https://authjs.dev/reference/adapter/prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  phone         String?   @unique

  // 用户等级系统
  tier          String    @default("free") // anonymous | free | pro | enterprise
  tierExpiresAt DateTime? // 等级过期时间（用于试用期、付费到期等）
  status        String    @default("active") // active | suspended | deleted

  // AI 配置模式
  aiMode        String    @default("system_default") // system_default | byok

  // 当前选中的 AI 配置（用户在设置里选择的 provider + 连接）
  selectedProviderConfigId String?
  selectedProviderConfig   ProviderConfig? @relation("SelectedConfig", fields: [selectedProviderConfigId], references: [id], onDelete: SetNull)

  accounts      Account[]
  sessions      Session[]

  conversations   Conversation[]
  providerConfigs ProviderConfig[] @relation("UserConfigs")
  quotaUsage      UserQuotaUsage[]
  roles           UserRole[]
  auditLogs       AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier])
  @@index([tierExpiresAt])
  @@index([status])
  @@index([aiMode])
  @@index([selectedProviderConfigId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 应用会话（对齐现有 localStorage 的 conversation 概念）
// 先做最小可用数据模型：后续再加入“共享/权限/团队空间”等能力（YAGNI）。
model Conversation {
  userId    String
  id        String
  title     String?
  // 客户端时间戳（用于排序/避免回拉覆盖本地更新）
  clientCreatedAt DateTime
  clientUpdatedAt DateTime
  // 会话完整载荷（与当前 localStorage 结构对齐，便于无感同步）
  // { messages, xml, snapshots, sessionId }
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, id])
  @@index([userId, updatedAt])
  @@index([userId, clientUpdatedAt])
}

// 用于增量同步的事件流游标（单调递增，避免 updatedAt 边界漏拉）
model SyncEvent {
  id             BigInt   @id @default(autoincrement())
  userId         String
  conversationId String
  type           String   // upsert/delete
  createdAt      DateTime @default(now())

  @@index([userId, id])
  @@index([userId, conversationId, id])
}

// 匿名用户（按 IP）限额计数器：用于服务端强制限流，避免仅依赖 localStorage 被绕过。
model AnonymousRateLimit {
  ipHash     String
  bucketType String // day-requests | day-tokens | minute-tokens
  bucketKey  String // 例如：2025-12-13 或 29279312(分钟桶)
  count      BigInt @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([ipHash, bucketType, bucketKey])
  @@index([bucketType, bucketKey])
  @@index([ipHash, updatedAt])
}

// AI Provider 配置（用户自定义连接信息，支持 BYOK 云端同步）
model ProviderConfig {
  id       String @id @default(cuid())
  userId   String
  // 支持: bedrock, openai, openai_compatible, anthropic, google, azure, ollama, openrouter, deepseek, siliconflow
  provider String

  // 连接别名（同一 provider 下可多条）
  name      String @default("default")
  isDefault Boolean @default(false)
  isDisabled Boolean @default(false)

  // 模型模式：fast（快速）或 max（深度思考）
  modelMode String @default("fast") // fast | max

  // 可选配置
  baseUrl     String?
  modelId     String?
  headers     Json?
  extraConfig Json?

  // 统一凭证（加密 JSON 字符串）
  credentialType       String @default("apiKey")
  encryptedCredentials String?
  credentialsIv        String?
  credentialsAuthTag   String?
  credentialsVersion   Int     @default(1)

  // 常见 provider 参数（便于显式配置）
  orgId        String?
  apiVersion   String?
  region       String?
  resourceName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User   @relation("UserConfigs", fields: [userId], references: [id], onDelete: Cascade)
  selectedByUsers User[] @relation("SelectedConfig")

  @@unique([userId, provider, name, modelMode])
  @@index([userId])
  @@index([provider])
  @@index([credentialsVersion])
  @@index([modelMode])
}

// Provider 默认配置目录（系统级）
model ProviderCatalog {
  id              String   @id @default(cuid())
  key             String   @unique
  displayName     String
  compatibility   String   // native | openai_compat
  authType        String   // apiKey | aws | oauth | none | custom
  defaultBaseUrl  String?
  defaultModelId  String?
  defaultHeaders  Json?
  defaultParams   Json?
  // 建议模型列表，存储为 JSON 数组: [{ id: string, label?: string }]
  suggestedModels Json?
  isBuiltin       Boolean  @default(true)
  isActive        Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// 系统级连接凭证（支持每个 Provider 多套凭证）
model SystemCredential {
  id       String @id @default(cuid())
  provider String // openrouter, openai, anthropic, etc.
  name     String @default("default") // 凭证别名

  // 可选覆盖（优先级高于 ProviderCatalog）
  baseUrl String?

  // 加密凭证（与 ProviderConfig 结构一致）
  credentialType       String  @default("apiKey") // apiKey | aws | oauth
  encryptedCredentials String?
  credentialsIv        String?
  credentialsAuthTag   String?
  credentialsVersion   Int     @default(1)

  // AWS 特定字段（如需要）
  region       String?
  resourceName String?

  isDefault  Boolean @default(false) // 该 provider 下的默认凭证
  isDisabled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, name])
  @@index([provider])
  @@index([provider, isDefault])
  @@index([isDisabled])
}

// SMS 验证码（用于手机号登录）
model SmsVerificationCode {
  id           String   @id @default(cuid())
  phone        String
  purpose      String   // login_phone | register_phone
  codeHash     String   // SHA-256 hash of the verification code
  expiresAt    DateTime
  verifiedAt   DateTime?
  attemptCount Int      @default(0)
  createdAt    DateTime @default(now())

  @@index([phone, purpose, createdAt])
  @@index([expiresAt])
}

// 等级配置表（动态配额管理）
model TierConfig {
  tier              String   @id // anonymous | free | pro | enterprise
  displayName       String   // 显示名称，如"免费版"
  dailyRequestLimit Int      @default(0) // 每日请求数，0 表示无限
  dailyTokenLimit   BigInt   @default(0) // 每日 Token 总数
  tpmLimit          Int      @default(0) // 每分钟 Token 数（TPM）
  enabled           Boolean  @default(true) // 是否启用该等级
  sortOrder         Int      @default(0) // 排序权重
  description       String?  // 等级描述（用于前端展示）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enabled, sortOrder])
}

// 用户配额使用记录表（已认证用户）
model UserQuotaUsage {
  userId     String
  bucketType String // day-requests | day-tokens | minute-tokens
  bucketKey  String // 时间桶键：如 "2025-12-15" 或分钟戳
  count      BigInt @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, bucketType, bucketKey])
  @@index([bucketType, bucketKey])
  @@index([userId, updatedAt])
}

// ============ RBAC 权限系统 ============

// 角色表
model Role {
  id          String   @id @default(cuid())
  name        String   @unique // superAdmin | admin | moderator | viewer
  displayName String
  description String?

  permissions Permission[]
  users       UserRole[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// 权限表
model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // users:read, users:write, tiers:write
  resource    String   // users, tiers, quotas, logs
  action      String   // read, write, delete
  description String?

  roles Role[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resource, action])
}

// 用户角色关联表
model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// 审计日志表
model AuditLog {
  id           String  @id @default(cuid())
  userId       String
  action       String  // user:update, tier:update, quota:reset
  resourceType String  // user, tier_config, quota
  resourceId   String

  // 变更详情
  beforeValue    Json?
  afterValue     Json?
  changesSummary String?

  // 请求上下文
  ipAddress String?
  userAgent String?

  // 结果
  status       String  // success, failed
  errorMessage String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resourceType, resourceId])
}

// 系统配置表
model SystemConfig {
  key         String @id
  value       Json
  category    String // general, ai, notification
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
}
